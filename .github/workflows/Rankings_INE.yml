name: DGT · Rankings INE (Parquet → CSV en Drive)

on:
  workflow_dispatch:
    inputs:
      location:
        description: "ine=XXXXX | mun=Nombre;provincia=...;ccaa=..."
        required: false
      period:
        description: "anio=YYYY | start=yyyymm;end=yyyymm"
        required: false
      filters:
        description: "marca=...;modelo=...;combustible=..."
        required: false
      options:
        description: "by_combustible=true;mix=true;vs_prev=false;timeseries=false"
        required: false
        default: "by_combustible=false;mix=true;vs_prev=false;timeseries=false"
      top:
        description: "Top N"
        required: false
        default: "20"
      format:
        description: "table|csv"
        required: false
        default: "table"
      chunksize:
        description: "Solo si el input fuera CSV"
        required: false
      dry_run:
        description: "true|false (no sube ficheros si true)"
        required: false
        default: "false"

concurrency:
  group: dgt-rankings
  cancel-in-progress: false

env:
  GOOGLE_OAUTH_B64: ${{ secrets.GOOGLE_OAUTH_B64 }}
  GOOGLE_DRIVE_SCOPE: https://www.googleapis.com/auth/drive.file
  BCA_MONTHLY_FOLDER_ID: ${{ secrets.BCA_MONTHLY_FOLDER_ID }}
  DGT_ANALISIS_FOLDER_ID: ${{ secrets.DGT_ANALISIS_FOLDER_ID }}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pyarrow pandas google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2

      - name: Prepare workspace
        run: |
          mkdir -p data
          mkdir -p outputs

      # ↓↓↓ Descarga cloud (estilo BCA) ↓↓↓
      - name: Fetch latest Parquet from BCA monthly folder
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - << 'PY'
          from pathlib import Path
          from gdrive_auth import authenticate_drive
          from googleapiclient.http import MediaIoBaseDownload
          import io, os
          FOLDER_ID = os.environ["BCA_MONTHLY_FOLDER_ID"]
          svc = authenticate_drive()
          q = " and ".join([
            f"'{FOLDER_ID}' in parents",
            "trashed = false"
          ])
          resp = svc.files().list(
            q=q, fields="files(id,name,modifiedTime,mimeType)",
            orderBy="modifiedTime desc",
            pageSize=1000, includeItemsFromAllDrives=True, supportsAllDrives=True
          ).execute()
          files = resp.get("files", [])
          target = None
          for f in files:
            if f["name"].lower().endswith(".parquet") and "agg_transmisiones_ine" in f["name"].lower():
              target = f; break
          if target is None:
            for f in files:
              if f["name"].lower().endswith(".parquet"):
                target = f; break
          if target is None:
            raise SystemExit("⛔ No hay .parquet en la carpeta BCA_MONTHLY_FOLDER_ID.")
          fid, name = target["id"], target["name"]
          print("Seleccionado:", name)
          req = svc.files().get_media(fileId=fid)
          buf = io.BytesIO()
          dl = MediaIoBaseDownload(buf, req)
          done = False
          while not done:
              _, done = dl.next_chunk()
          Path(name).write_bytes(buf.getvalue())
          print(f"✅ Descargado {name}")
          PY


      - name: Build CLI flags (robusto en Python)
        id: flags
        env:
          IN_LOCATION: ${{ github.event.inputs.location }}
          IN_PERIOD: ${{ github.event.inputs.period }}
          IN_FILTERS: ${{ github.event.inputs.filters }}
          IN_OPTIONS: ${{ github.event.inputs.options }}
          IN_TOP: ${{ github.event.inputs.top }}
          IN_FORMAT: ${{ github.event.inputs.format }}
          IN_CHUNKSIZE: ${{ github.event.inputs.chunksize }}
          IN_DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          python - << 'PY'
          import os, shlex

          def parse(s):
              if not s: return []
              parts=[]
              for kv in filter(None, [p.strip() for p in s.split(';')]):
                  if '=' not in kv: 
                      continue
                  k,v=kv.split('=',1)
                  k=k.strip(); v=v.strip()
                  if not k or v=='':
                      continue
                  # numéricos directos
                  if k in ('ine','anio','start','end','chunksize','top'):
                      parts += [f'--{k}', v] if k!='ine' else ['--ine', v]
                  # string con comillas
                  elif k in ('mun','provincia','ccaa','marca','modelo','combustible'):
                      parts += [f'--{k}', v]
                  # booleanos → flags
                  elif k in ('by_combustible','mix','mix_combustible','vs_prev','timeseries'):
                      if v.lower()=='true':
                          flag = {'mix':'mix-combustible','mix_combustible':'mix-combustible'}.get(k,k)
                          parts += [f'--{flag}']
              return parts

          flags=[]
          flags += parse(os.getenv('IN_LOCATION',''))
          flags += parse(os.getenv('IN_PERIOD',''))
          flags += parse(os.getenv('IN_FILTERS',''))
          flags += parse(os.getenv('IN_OPTIONS',''))

          fmt=os.getenv('IN_FORMAT','')
          if fmt: flags += ['--format', fmt]

          ch=os.getenv('IN_CHUNKSIZE','')
          if ch: flags += ['--chunksize', ch]

          if os.getenv('IN_DRY_RUN','false').lower()=='true':
              flags += ['--dry-run']

          top=os.getenv('IN_TOP','')
          if top: flags += ['--top', top]

          # Escapar seguro para shell
          out=' '.join(shlex.quote(x) for x in flags)
          # Exponer como output multiline para evitar escapes raros
          with open(os.environ['GITHUB_OUTPUT'],'a') as f:
              f.write('flags<<EOF\n'); f.write(out + '\n'); f.write('EOF\n')

          print('FLAGS:', out)
          PY


      - name: Run rankings_ine.py (Parquet input)
        env:
          MUNICIPIOS_INE_CSV: municipios_ine.csv
        run: |
          INP="$(ls -1 *.parquet | head -n1)"
          echo "Usando Parquet: $INP"
          python rankings_ine.py ${{ steps.flags.outputs.flags }} --data "$INP" --show

      - name: Upload outputs to Drive (DGT_ANALISIS_FOLDER_ID)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python - << 'PY'
          from pathlib import Path
          from gdrive_auth import authenticate_drive
          from googleapiclient.http import MediaFileUpload
          import os, sys
          FOLDER_ID = os.environ["DGT_ANALISIS_FOLDER_ID"]
          svc = authenticate_drive()
          files = list(Path(".").glob("ranking_*.csv")) + \
                  list(Path(".").glob("ranking_*.json")) + \
                  list(Path(".").glob("mix_combustible_*.csv")) + \
                  list(Path(".").glob("mix_combustible_*.json")) + \
                  list(Path(".").glob("timeseries_*.csv")) + \
                  list(Path(".").glob("timeseries_*.json"))
          if not files:
            print("⚠️ No hay ficheros para subir."); sys.exit(0)
          for p in files:
            media = MediaFileUpload(str(p), resumable=True)
            body = {"name": p.name, "parents": [FOLDER_ID]}
            svc.files().create(body=body, media_body=media, supportsAllDrives=True).execute()
            print("⬆️  Uploaded:", p.name)
          print("✅ Subida completada.")
          PY

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: dgt-rankings
          path: |
            ranking_*.csv
            ranking_*.json
            mix_combustible_*.csv
            mix_combustible_*.json
            timeseries_*.csv
            timeseries_*.json

